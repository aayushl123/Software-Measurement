<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CompositeDisposableTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RxJava_2_x$Unnamed.exec</a> &gt; <a href="index.source.html" class="el_package">io.reactivex.disposables</a> &gt; <span class="el_source">CompositeDisposableTest.java</span></div><h1>CompositeDisposableTest.java</h1><pre class="source lang-java linenums">/**
 * Copyright (c) 2016-present, RxJava Contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is
 * distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See
 * the License for the specific language governing permissions and limitations under the License.
 */

package io.reactivex.disposables;

import static org.junit.Assert.*;

import java.io.IOException;
import java.util.*;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.atomic.AtomicInteger;

import org.junit.Test;

import io.reactivex.TestHelper;
import io.reactivex.exceptions.CompositeException;
import io.reactivex.functions.Action;

<span class="fc" id="L29">public class CompositeDisposableTest {</span>

    @Test
    public void testSuccess() {
<span class="fc" id="L33">        final AtomicInteger counter = new AtomicInteger();</span>
<span class="fc" id="L34">        CompositeDisposable cd = new CompositeDisposable();</span>
<span class="fc" id="L35">        cd.add(Disposables.fromRunnable(new Runnable() {</span>

            @Override
            public void run() {
<span class="fc" id="L39">                counter.incrementAndGet();</span>
<span class="fc" id="L40">            }</span>

        }));

<span class="fc" id="L44">        cd.add(Disposables.fromRunnable(new Runnable() {</span>

            @Override
            public void run() {
<span class="fc" id="L48">                counter.incrementAndGet();</span>
<span class="fc" id="L49">            }</span>
        }));

<span class="fc" id="L52">        cd.dispose();</span>

<span class="fc" id="L54">        assertEquals(2, counter.get());</span>
<span class="fc" id="L55">    }</span>

    @Test(timeout = 1000)
    public void shouldUnsubscribeAll() throws InterruptedException {
<span class="fc" id="L59">        final AtomicInteger counter = new AtomicInteger();</span>
<span class="fc" id="L60">        final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L62">        final int count = 10;</span>
<span class="fc" id="L63">        final CountDownLatch start = new CountDownLatch(1);</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">        for (int i = 0; i &lt; count; i++) {</span>
<span class="fc" id="L65">            cd.add(Disposables.fromRunnable(new Runnable() {</span>

                @Override
                public void run() {
<span class="fc" id="L69">                    counter.incrementAndGet();</span>
<span class="fc" id="L70">                }</span>
            }));
        }

<span class="fc" id="L74">        final List&lt;Thread&gt; threads = new ArrayList&lt;Thread&gt;();</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        for (int i = 0; i &lt; count; i++) {</span>
<span class="fc" id="L76">            final Thread t = new Thread() {</span>
                @Override
                public void run() {
                    try {
<span class="fc" id="L80">                        start.await();</span>
<span class="fc" id="L81">                        cd.dispose();</span>
<span class="nc" id="L82">                    } catch (final InterruptedException e) {</span>
<span class="nc" id="L83">                        fail(e.getMessage());</span>
<span class="fc" id="L84">                    }</span>
<span class="fc" id="L85">                }</span>
            };
<span class="fc" id="L87">            t.start();</span>
<span class="fc" id="L88">            threads.add(t);</span>
        }

<span class="fc" id="L91">        start.countDown();</span>
<span class="fc bfc" id="L92" title="All 2 branches covered.">        for (final Thread t : threads) {</span>
<span class="fc" id="L93">            t.join();</span>
<span class="fc" id="L94">        }</span>

<span class="fc" id="L96">        assertEquals(count, counter.get());</span>
<span class="fc" id="L97">    }</span>

    @Test
    public void testException() {
<span class="fc" id="L101">        final AtomicInteger counter = new AtomicInteger();</span>
<span class="fc" id="L102">        CompositeDisposable cd = new CompositeDisposable();</span>
<span class="fc" id="L103">        cd.add(Disposables.fromRunnable(new Runnable() {</span>

            @Override
            public void run() {
<span class="fc" id="L107">                throw new RuntimeException(&quot;failed on first one&quot;);</span>
            }

        }));

<span class="fc" id="L112">        cd.add(Disposables.fromRunnable(new Runnable() {</span>

            @Override
            public void run() {
<span class="fc" id="L116">                counter.incrementAndGet();</span>
<span class="fc" id="L117">            }</span>

        }));

        try {
<span class="nc" id="L122">            cd.dispose();</span>
<span class="nc" id="L123">            fail(&quot;Expecting an exception&quot;);</span>
<span class="fc" id="L124">        } catch (RuntimeException e) {</span>
            // we expect this
<span class="fc" id="L126">            assertEquals(e.getMessage(), &quot;failed on first one&quot;);</span>
<span class="nc" id="L127">        }</span>

        // we should still have disposed to the second one
<span class="fc" id="L130">        assertEquals(1, counter.get());</span>
<span class="fc" id="L131">    }</span>

    @Test
    public void testCompositeException() {
<span class="fc" id="L135">        final AtomicInteger counter = new AtomicInteger();</span>
<span class="fc" id="L136">        CompositeDisposable cd = new CompositeDisposable();</span>
<span class="fc" id="L137">        cd.add(Disposables.fromRunnable(new Runnable() {</span>

            @Override
            public void run() {
<span class="fc" id="L141">                throw new RuntimeException(&quot;failed on first one&quot;);</span>
            }

        }));

<span class="fc" id="L146">        cd.add(Disposables.fromRunnable(new Runnable() {</span>

            @Override
            public void run() {
<span class="fc" id="L150">                throw new RuntimeException(&quot;failed on second one too&quot;);</span>
            }
        }));

<span class="fc" id="L154">        cd.add(Disposables.fromRunnable(new Runnable() {</span>

            @Override
            public void run() {
<span class="fc" id="L158">                counter.incrementAndGet();</span>
<span class="fc" id="L159">            }</span>

        }));

        try {
<span class="nc" id="L164">            cd.dispose();</span>
<span class="nc" id="L165">            fail(&quot;Expecting an exception&quot;);</span>
<span class="fc" id="L166">        } catch (CompositeException e) {</span>
            // we expect this
<span class="fc" id="L168">            assertEquals(e.getExceptions().size(), 2);</span>
<span class="nc" id="L169">        }</span>

        // we should still have disposed to the second one
<span class="fc" id="L172">        assertEquals(1, counter.get());</span>
<span class="fc" id="L173">    }</span>

    @Test
    public void testRemoveUnsubscribes() {
<span class="fc" id="L177">        Disposable d1 = Disposables.empty();</span>
<span class="fc" id="L178">        Disposable d2 = Disposables.empty();</span>

<span class="fc" id="L180">        CompositeDisposable cd = new CompositeDisposable();</span>
<span class="fc" id="L181">        cd.add(d1);</span>
<span class="fc" id="L182">        cd.add(d2);</span>

<span class="fc" id="L184">        cd.remove(d1);</span>

<span class="fc" id="L186">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L187">        assertFalse(d2.isDisposed());</span>
<span class="fc" id="L188">    }</span>

    @Test
    public void testClear() {
<span class="fc" id="L192">        Disposable d1 = Disposables.empty();</span>
<span class="fc" id="L193">        Disposable d2 = Disposables.empty();</span>

<span class="fc" id="L195">        CompositeDisposable cd = new CompositeDisposable();</span>
<span class="fc" id="L196">        cd.add(d1);</span>
<span class="fc" id="L197">        cd.add(d2);</span>

<span class="fc" id="L199">        assertFalse(d1.isDisposed());</span>
<span class="fc" id="L200">        assertFalse(d2.isDisposed());</span>

<span class="fc" id="L202">        cd.clear();</span>

<span class="fc" id="L204">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L205">        assertTrue(d2.isDisposed());</span>
<span class="fc" id="L206">        assertFalse(cd.isDisposed());</span>

<span class="fc" id="L208">        Disposable d3 = Disposables.empty();</span>

<span class="fc" id="L210">        cd.add(d3);</span>
<span class="fc" id="L211">        cd.dispose();</span>

<span class="fc" id="L213">        assertTrue(d3.isDisposed());</span>
<span class="fc" id="L214">        assertTrue(cd.isDisposed());</span>
<span class="fc" id="L215">    }</span>

    @Test
    public void testUnsubscribeIdempotence() {
<span class="fc" id="L219">        final AtomicInteger counter = new AtomicInteger();</span>
<span class="fc" id="L220">        CompositeDisposable cd = new CompositeDisposable();</span>
<span class="fc" id="L221">        cd.add(Disposables.fromRunnable(new Runnable() {</span>

            @Override
            public void run() {
<span class="fc" id="L225">                counter.incrementAndGet();</span>
<span class="fc" id="L226">            }</span>

        }));

<span class="fc" id="L230">        cd.dispose();</span>
<span class="fc" id="L231">        cd.dispose();</span>
<span class="fc" id="L232">        cd.dispose();</span>

        // we should have only disposed once
<span class="fc" id="L235">        assertEquals(1, counter.get());</span>
<span class="fc" id="L236">    }</span>

    @Test(timeout = 1000)
    public void testUnsubscribeIdempotenceConcurrently()
            throws InterruptedException {
<span class="fc" id="L241">        final AtomicInteger counter = new AtomicInteger();</span>
<span class="fc" id="L242">        final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L244">        final int count = 10;</span>
<span class="fc" id="L245">        final CountDownLatch start = new CountDownLatch(1);</span>
<span class="fc" id="L246">        cd.add(Disposables.fromRunnable(new Runnable() {</span>

            @Override
            public void run() {
<span class="fc" id="L250">                counter.incrementAndGet();</span>
<span class="fc" id="L251">            }</span>

        }));

<span class="fc" id="L255">        final List&lt;Thread&gt; threads = new ArrayList&lt;Thread&gt;();</span>
<span class="fc bfc" id="L256" title="All 2 branches covered.">        for (int i = 0; i &lt; count; i++) {</span>
<span class="fc" id="L257">            final Thread t = new Thread() {</span>
                @Override
                public void run() {
                    try {
<span class="fc" id="L261">                        start.await();</span>
<span class="fc" id="L262">                        cd.dispose();</span>
<span class="nc" id="L263">                    } catch (final InterruptedException e) {</span>
<span class="nc" id="L264">                        fail(e.getMessage());</span>
<span class="fc" id="L265">                    }</span>
<span class="fc" id="L266">                }</span>
            };
<span class="fc" id="L268">            t.start();</span>
<span class="fc" id="L269">            threads.add(t);</span>
        }

<span class="fc" id="L272">        start.countDown();</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">        for (final Thread t : threads) {</span>
<span class="fc" id="L274">            t.join();</span>
<span class="fc" id="L275">        }</span>

        // we should have only disposed once
<span class="fc" id="L278">        assertEquals(1, counter.get());</span>
<span class="fc" id="L279">    }</span>

    @Test
    public void testTryRemoveIfNotIn() {
<span class="fc" id="L283">        CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L285">        CompositeDisposable cd1 = new CompositeDisposable();</span>
<span class="fc" id="L286">        CompositeDisposable cd2 = new CompositeDisposable();</span>

<span class="fc" id="L288">        cd.add(cd1);</span>
<span class="fc" id="L289">        cd.remove(cd1);</span>
<span class="fc" id="L290">        cd.add(cd2);</span>

<span class="fc" id="L292">        cd.remove(cd1); // try removing agian</span>
<span class="fc" id="L293">    }</span>

    @Test(expected = NullPointerException.class)
    public void testAddingNullDisposableIllegal() {
<span class="fc" id="L297">        CompositeDisposable cd = new CompositeDisposable();</span>
<span class="nc" id="L298">        cd.add(null);</span>
<span class="nc" id="L299">    }</span>

    @Test
    public void initializeVarargs() {
<span class="fc" id="L303">        Disposable d1 = Disposables.empty();</span>
<span class="fc" id="L304">        Disposable d2 = Disposables.empty();</span>

<span class="fc" id="L306">        CompositeDisposable cd = new CompositeDisposable(d1, d2);</span>

<span class="fc" id="L308">        assertEquals(2, cd.size());</span>

<span class="fc" id="L310">        cd.clear();</span>

<span class="fc" id="L312">        assertEquals(0, cd.size());</span>

<span class="fc" id="L314">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L315">        assertTrue(d2.isDisposed());</span>

<span class="fc" id="L317">        Disposable d3 = Disposables.empty();</span>
<span class="fc" id="L318">        Disposable d4 = Disposables.empty();</span>

<span class="fc" id="L320">        cd = new CompositeDisposable(d3, d4);</span>

<span class="fc" id="L322">        cd.dispose();</span>

<span class="fc" id="L324">        assertTrue(d3.isDisposed());</span>
<span class="fc" id="L325">        assertTrue(d4.isDisposed());</span>

<span class="fc" id="L327">        assertEquals(0, cd.size());</span>
<span class="fc" id="L328">    }</span>

    @Test
    public void initializeIterable() {
<span class="fc" id="L332">        Disposable d1 = Disposables.empty();</span>
<span class="fc" id="L333">        Disposable d2 = Disposables.empty();</span>

<span class="fc" id="L335">        CompositeDisposable cd = new CompositeDisposable(Arrays.asList(d1, d2));</span>

<span class="fc" id="L337">        assertEquals(2, cd.size());</span>

<span class="fc" id="L339">        cd.clear();</span>

<span class="fc" id="L341">        assertEquals(0, cd.size());</span>

<span class="fc" id="L343">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L344">        assertTrue(d2.isDisposed());</span>

<span class="fc" id="L346">        Disposable d3 = Disposables.empty();</span>
<span class="fc" id="L347">        Disposable d4 = Disposables.empty();</span>

<span class="fc" id="L349">        cd = new CompositeDisposable(Arrays.asList(d3, d4));</span>

<span class="fc" id="L351">        assertEquals(2, cd.size());</span>

<span class="fc" id="L353">        cd.dispose();</span>

<span class="fc" id="L355">        assertTrue(d3.isDisposed());</span>
<span class="fc" id="L356">        assertTrue(d4.isDisposed());</span>

<span class="fc" id="L358">        assertEquals(0, cd.size());</span>
<span class="fc" id="L359">    }</span>

    @Test
    public void addAll() {
<span class="fc" id="L363">        CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L365">        Disposable d1 = Disposables.empty();</span>
<span class="fc" id="L366">        Disposable d2 = Disposables.empty();</span>
<span class="fc" id="L367">        Disposable d3 = Disposables.empty();</span>

<span class="fc" id="L369">        cd.addAll(d1, d2);</span>
<span class="fc" id="L370">        cd.addAll(d3);</span>

<span class="fc" id="L372">        assertFalse(d1.isDisposed());</span>
<span class="fc" id="L373">        assertFalse(d2.isDisposed());</span>
<span class="fc" id="L374">        assertFalse(d3.isDisposed());</span>

<span class="fc" id="L376">        cd.clear();</span>

<span class="fc" id="L378">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L379">        assertTrue(d2.isDisposed());</span>

<span class="fc" id="L381">        d1 = Disposables.empty();</span>
<span class="fc" id="L382">        d2 = Disposables.empty();</span>

<span class="fc" id="L384">        cd = new CompositeDisposable();</span>

<span class="fc" id="L386">        cd.addAll(d1, d2);</span>

<span class="fc" id="L388">        assertFalse(d1.isDisposed());</span>
<span class="fc" id="L389">        assertFalse(d2.isDisposed());</span>

<span class="fc" id="L391">        cd.dispose();</span>

<span class="fc" id="L393">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L394">        assertTrue(d2.isDisposed());</span>

<span class="fc" id="L396">        assertEquals(0, cd.size());</span>

<span class="fc" id="L398">        cd.clear();</span>

<span class="fc" id="L400">        assertEquals(0, cd.size());</span>
<span class="fc" id="L401">    }</span>

    @Test
    public void addAfterDisposed() {
<span class="fc" id="L405">        CompositeDisposable cd = new CompositeDisposable();</span>
<span class="fc" id="L406">        cd.dispose();</span>

<span class="fc" id="L408">        Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L410">        assertFalse(cd.add(d1));</span>

<span class="fc" id="L412">        assertTrue(d1.isDisposed());</span>

<span class="fc" id="L414">        d1 = Disposables.empty();</span>
<span class="fc" id="L415">        Disposable d2 = Disposables.empty();</span>

<span class="fc" id="L417">        assertFalse(cd.addAll(d1, d2));</span>

<span class="fc" id="L419">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L420">        assertTrue(d2.isDisposed());</span>

<span class="fc" id="L422">    }</span>

    @Test
    public void delete() {

<span class="fc" id="L427">        CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L429">        Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L431">        assertFalse(cd.delete(d1));</span>

<span class="fc" id="L433">        Disposable d2 = Disposables.empty();</span>

<span class="fc" id="L435">        cd.add(d2);</span>

<span class="fc" id="L437">        assertFalse(cd.delete(d1));</span>

<span class="fc" id="L439">        cd.dispose();</span>

<span class="fc" id="L441">        assertFalse(cd.delete(d1));</span>
<span class="fc" id="L442">    }</span>

    @Test
    public void disposeRace() {
<span class="fc bfc" id="L446" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L447">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L449">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L452">                    cd.dispose();</span>
<span class="fc" id="L453">                }</span>
            };

<span class="fc" id="L456">            TestHelper.race(run, run);</span>
        }
<span class="fc" id="L458">    }</span>

    @Test
    public void addRace() {
<span class="fc bfc" id="L462" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L463">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L465">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L468">                    cd.add(Disposables.empty());</span>
<span class="fc" id="L469">                }</span>
            };

<span class="fc" id="L472">            TestHelper.race(run, run);</span>
        }
<span class="fc" id="L474">    }</span>

    @Test
    public void addAllRace() {
<span class="fc bfc" id="L478" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L479">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L481">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L484">                    cd.addAll(Disposables.empty());</span>
<span class="fc" id="L485">                }</span>
            };

<span class="fc" id="L488">            TestHelper.race(run, run);</span>
        }
<span class="fc" id="L490">    }</span>

    @Test
    public void removeRace() {
<span class="fc bfc" id="L494" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L495">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L497">            final Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L499">            cd.add(d1);</span>

<span class="fc" id="L501">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L504">                    cd.remove(d1);</span>
<span class="fc" id="L505">                }</span>
            };

<span class="fc" id="L508">            TestHelper.race(run, run);</span>
        }
<span class="fc" id="L510">    }</span>

    @Test
    public void deleteRace() {
<span class="fc bfc" id="L514" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L515">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L517">            final Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L519">            cd.add(d1);</span>

<span class="fc" id="L521">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L524">                    cd.delete(d1);</span>
<span class="fc" id="L525">                }</span>
            };

<span class="fc" id="L528">            TestHelper.race(run, run);</span>
        }
<span class="fc" id="L530">    }</span>

    @Test
    public void clearRace() {
<span class="fc bfc" id="L534" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L535">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L537">            final Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L539">            cd.add(d1);</span>

<span class="fc" id="L541">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L544">                    cd.clear();</span>
<span class="fc" id="L545">                }</span>
            };

<span class="fc" id="L548">            TestHelper.race(run, run);</span>
        }
<span class="fc" id="L550">    }</span>

    @Test
    public void addDisposeRace() {
<span class="fc bfc" id="L554" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L555">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L557">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L560">                    cd.dispose();</span>
<span class="fc" id="L561">                }</span>
            };

<span class="fc" id="L564">            Runnable run2 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L567">                    cd.add(Disposables.empty());</span>
<span class="fc" id="L568">                }</span>
            };

<span class="fc" id="L571">            TestHelper.race(run, run2);</span>
        }
<span class="fc" id="L573">    }</span>

    @Test
    public void addAllDisposeRace() {
<span class="fc bfc" id="L577" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L578">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L580">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L583">                    cd.dispose();</span>
<span class="fc" id="L584">                }</span>
            };

<span class="fc" id="L587">            Runnable run2 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L590">                    cd.addAll(Disposables.empty());</span>
<span class="fc" id="L591">                }</span>
            };

<span class="fc" id="L594">            TestHelper.race(run, run2);</span>
        }
<span class="fc" id="L596">    }</span>

    @Test
    public void removeDisposeRace() {
<span class="fc bfc" id="L600" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L601">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L603">            final Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L605">            cd.add(d1);</span>

<span class="fc" id="L607">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L610">                    cd.dispose();</span>
<span class="fc" id="L611">                }</span>
            };

<span class="fc" id="L614">            Runnable run2 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L617">                    cd.remove(d1);</span>
<span class="fc" id="L618">                }</span>
            };

<span class="fc" id="L621">            TestHelper.race(run, run2);</span>
        }
<span class="fc" id="L623">    }</span>

    @Test
    public void deleteDisposeRace() {
<span class="fc bfc" id="L627" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L628">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L630">            final Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L632">            cd.add(d1);</span>

<span class="fc" id="L634">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L637">                    cd.dispose();</span>
<span class="fc" id="L638">                }</span>
            };

<span class="fc" id="L641">            Runnable run2 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L644">                    cd.delete(d1);</span>
<span class="fc" id="L645">                }</span>
            };

<span class="fc" id="L648">            TestHelper.race(run, run2);</span>
        }
<span class="fc" id="L650">    }</span>

    @Test
    public void clearDisposeRace() {
<span class="fc bfc" id="L654" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L655">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L657">            final Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L659">            cd.add(d1);</span>

<span class="fc" id="L661">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L664">                    cd.dispose();</span>
<span class="fc" id="L665">                }</span>
            };

<span class="fc" id="L668">            Runnable run2 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L671">                    cd.clear();</span>
<span class="fc" id="L672">                }</span>
            };

<span class="fc" id="L675">            TestHelper.race(run, run2);</span>
        }
<span class="fc" id="L677">    }</span>

    @Test
    public void sizeDisposeRace() {
<span class="fc bfc" id="L681" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L682">            final CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L684">            final Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L686">            cd.add(d1);</span>

<span class="fc" id="L688">            Runnable run = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L691">                    cd.dispose();</span>
<span class="fc" id="L692">                }</span>
            };

<span class="fc" id="L695">            Runnable run2 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L698">                    cd.size();</span>
<span class="fc" id="L699">                }</span>
            };

<span class="fc" id="L702">            TestHelper.race(run, run2);</span>
        }
<span class="fc" id="L704">    }</span>

    @Test
    public void disposeThrowsIAE() {
<span class="fc" id="L708">        CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L710">        cd.add(Disposables.fromAction(new Action() {</span>
            @Override
            public void run() throws Exception {
<span class="fc" id="L713">                throw new IllegalArgumentException();</span>
            }
        }));

<span class="fc" id="L717">        Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L719">        cd.add(d1);</span>

        try {
<span class="nc" id="L722">            cd.dispose();</span>
<span class="nc" id="L723">            fail(&quot;Failed to throw&quot;);</span>
<span class="fc" id="L724">        } catch (IllegalArgumentException ex) {</span>
            // expected
<span class="nc" id="L726">        }</span>

<span class="fc" id="L728">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L729">    }</span>

    @Test
    public void disposeThrowsError() {
<span class="fc" id="L733">        CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L735">        cd.add(Disposables.fromAction(new Action() {</span>
            @Override
            public void run() throws Exception {
<span class="fc" id="L738">                throw new AssertionError();</span>
            }
        }));

<span class="fc" id="L742">        Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L744">        cd.add(d1);</span>

        try {
<span class="nc" id="L747">            cd.dispose();</span>
<span class="nc" id="L748">            fail(&quot;Failed to throw&quot;);</span>
<span class="fc" id="L749">        } catch (AssertionError ex) {</span>
            // expected
<span class="nc" id="L751">        }</span>

<span class="fc" id="L753">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L754">    }</span>

    @Test
    public void disposeThrowsCheckedException() {
<span class="fc" id="L758">        CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L760">        cd.add(Disposables.fromAction(new Action() {</span>
            @Override
            public void run() throws Exception {
<span class="fc" id="L763">                throw new IOException();</span>
            }
        }));

<span class="fc" id="L767">        Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L769">        cd.add(d1);</span>

        try {
<span class="nc" id="L772">            cd.dispose();</span>
<span class="nc" id="L773">            fail(&quot;Failed to throw&quot;);</span>
<span class="fc" id="L774">        } catch (RuntimeException ex) {</span>
            // expected
<span class="pc bpc" id="L776" title="1 of 2 branches missed.">            if (!(ex.getCause() instanceof IOException)) {</span>
<span class="nc" id="L777">                fail(ex.toString() + &quot; should have thrown RuntimeException(IOException)&quot;);</span>
            }
<span class="nc" id="L779">        }</span>

<span class="fc" id="L781">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L782">    }</span>

    @SuppressWarnings(&quot;unchecked&quot;)
    static &lt;E extends Throwable&gt; void throwSneaky() throws E {
<span class="fc" id="L786">        throw (E)new IOException();</span>
    }

    @Test
    public void disposeThrowsCheckedExceptionSneaky() {
<span class="fc" id="L791">        CompositeDisposable cd = new CompositeDisposable();</span>

<span class="fc" id="L793">        cd.add(new Disposable() {</span>
            @Override
            public void dispose() {
<span class="nc" id="L796">                CompositeDisposableTest.&lt;RuntimeException&gt;throwSneaky();</span>
<span class="nc" id="L797">            }</span>

            @Override
            public boolean isDisposed() {
                // TODO Auto-generated method stub
<span class="nc" id="L802">                return false;</span>
            }
        });

<span class="fc" id="L806">        Disposable d1 = Disposables.empty();</span>

<span class="fc" id="L808">        cd.add(d1);</span>

        try {
<span class="nc" id="L811">            cd.dispose();</span>
<span class="nc" id="L812">            fail(&quot;Failed to throw&quot;);</span>
<span class="fc" id="L813">        } catch (RuntimeException ex) {</span>
            // expected
<span class="pc bpc" id="L815" title="1 of 2 branches missed.">            if (!(ex.getCause() instanceof IOException)) {</span>
<span class="nc" id="L816">                fail(ex.toString() + &quot; should have thrown RuntimeException(IOException)&quot;);</span>
            }
<span class="nc" id="L818">        }</span>

<span class="fc" id="L820">        assertTrue(d1.isDisposed());</span>
<span class="fc" id="L821">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>