<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SingleUsingTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RxJava_2_x$Unnamed.exec</a> &gt; <a href="index.source.html" class="el_package">io.reactivex.internal.operators.single</a> &gt; <span class="el_source">SingleUsingTest.java</span></div><h1>SingleUsingTest.java</h1><pre class="source lang-java linenums">/**
 * Copyright (c) 2016-present, RxJava Contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is
 * distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See
 * the License for the specific language governing permissions and limitations under the License.
 */

package io.reactivex.internal.operators.single;

import static org.junit.Assert.*;

import java.util.List;
import java.util.concurrent.Callable;

import org.junit.Test;

import io.reactivex.*;
import io.reactivex.disposables.*;
import io.reactivex.exceptions.*;
import io.reactivex.functions.*;
import io.reactivex.internal.functions.Functions;
import io.reactivex.observers.TestObserver;
import io.reactivex.plugins.RxJavaPlugins;
import io.reactivex.processors.PublishProcessor;

<span class="fc" id="L32">public class SingleUsingTest {</span>

<span class="fc" id="L34">    Function&lt;Disposable, Single&lt;Integer&gt;&gt; mapper = new Function&lt;Disposable, Single&lt;Integer&gt;&gt;() {</span>
        @Override
        public Single&lt;Integer&gt; apply(Disposable d) throws Exception {
<span class="fc" id="L37">            return Single.just(1);</span>
        }
    };

<span class="fc" id="L41">    Function&lt;Disposable, Single&lt;Integer&gt;&gt; mapperThrows = new Function&lt;Disposable, Single&lt;Integer&gt;&gt;() {</span>
        @Override
        public Single&lt;Integer&gt; apply(Disposable d) throws Exception {
<span class="fc" id="L44">            throw new TestException(&quot;Mapper&quot;);</span>
        }
    };

<span class="fc" id="L48">    Consumer&lt;Disposable&gt; disposer = new Consumer&lt;Disposable&gt;() {</span>
        @Override
        public void accept(Disposable d) throws Exception {
<span class="fc" id="L51">            d.dispose();</span>
<span class="fc" id="L52">        }</span>
    };

<span class="fc" id="L55">    Consumer&lt;Disposable&gt; disposerThrows = new Consumer&lt;Disposable&gt;() {</span>
        @Override
        public void accept(Disposable d) throws Exception {
<span class="fc" id="L58">            throw new TestException(&quot;Disposer&quot;);</span>
        }
    };

    @Test
    public void resourceSupplierThrows() {
<span class="fc" id="L64">        Single.using(new Callable&lt;Integer&gt;() {</span>
            @Override
            public Integer call() throws Exception {
<span class="fc" id="L67">                throw new TestException();</span>
            }
<span class="fc" id="L69">        }, Functions.justFunction(Single.just(1)), Functions.emptyConsumer())</span>
<span class="fc" id="L70">        .test()</span>
<span class="fc" id="L71">        .assertFailure(TestException.class);</span>
<span class="fc" id="L72">    }</span>

    @Test
    public void normalEager() {
<span class="fc" id="L76">        Single.using(Functions.justCallable(1), Functions.justFunction(Single.just(1)), Functions.emptyConsumer())</span>
<span class="fc" id="L77">        .test()</span>
<span class="fc" id="L78">        .assertResult(1);</span>
<span class="fc" id="L79">    }</span>

    @Test
    public void normalNonEager() {
<span class="fc" id="L83">        Single.using(Functions.justCallable(1), Functions.justFunction(Single.just(1)), Functions.emptyConsumer(), false)</span>
<span class="fc" id="L84">        .test()</span>
<span class="fc" id="L85">        .assertResult(1);</span>
<span class="fc" id="L86">    }</span>

    @Test
    public void errorEager() {
<span class="fc" id="L90">        Single.using(Functions.justCallable(1), Functions.justFunction(Single.error(new TestException())), Functions.emptyConsumer())</span>
<span class="fc" id="L91">        .test()</span>
<span class="fc" id="L92">        .assertFailure(TestException.class);</span>
<span class="fc" id="L93">    }</span>

    @Test
    public void errorNonEager() {
<span class="fc" id="L97">        Single.using(Functions.justCallable(1), Functions.justFunction(Single.error(new TestException())), Functions.emptyConsumer(), false)</span>
<span class="fc" id="L98">        .test()</span>
<span class="fc" id="L99">        .assertFailure(TestException.class);</span>
<span class="fc" id="L100">    }</span>

    @Test
    public void eagerMapperThrowsDisposerThrows() {
<span class="fc" id="L104">        TestObserver&lt;Integer&gt; to = Single.using(Functions.justCallable(Disposables.empty()), mapperThrows, disposerThrows)</span>
<span class="fc" id="L105">        .test()</span>
<span class="fc" id="L106">        .assertFailure(CompositeException.class);</span>

<span class="fc" id="L108">        List&lt;Throwable&gt; ce = TestHelper.compositeList(to.errors().get(0));</span>
<span class="fc" id="L109">        TestHelper.assertError(ce, 0, TestException.class, &quot;Mapper&quot;);</span>
<span class="fc" id="L110">        TestHelper.assertError(ce, 1, TestException.class, &quot;Disposer&quot;);</span>
<span class="fc" id="L111">    }</span>

    @Test
    public void noneagerMapperThrowsDisposerThrows() {

<span class="fc" id="L116">        List&lt;Throwable&gt; errors = TestHelper.trackPluginErrors();</span>

        try {
<span class="fc" id="L119">            Single.using(Functions.justCallable(Disposables.empty()), mapperThrows, disposerThrows, false)</span>
<span class="fc" id="L120">            .test()</span>
<span class="fc" id="L121">            .assertFailureAndMessage(TestException.class, &quot;Mapper&quot;);</span>

<span class="fc" id="L123">            TestHelper.assertUndeliverable(errors, 0, TestException.class, &quot;Disposer&quot;);</span>
        } finally {
<span class="fc" id="L125">            RxJavaPlugins.reset();</span>
        }
<span class="fc" id="L127">    }</span>

    @Test
    public void resourceDisposedIfMapperCrashes() {
<span class="fc" id="L131">        Disposable d = Disposables.empty();</span>

<span class="fc" id="L133">        Single.using(Functions.justCallable(d), mapperThrows, disposer)</span>
<span class="fc" id="L134">        .test()</span>
<span class="fc" id="L135">        .assertFailure(TestException.class);</span>

<span class="fc" id="L137">        assertTrue(d.isDisposed());</span>
<span class="fc" id="L138">    }</span>

    @Test
    public void resourceDisposedIfMapperCrashesNonEager() {
<span class="fc" id="L142">        Disposable d = Disposables.empty();</span>

<span class="fc" id="L144">        Single.using(Functions.justCallable(d), mapperThrows, disposer, false)</span>
<span class="fc" id="L145">        .test()</span>
<span class="fc" id="L146">        .assertFailure(TestException.class);</span>

<span class="fc" id="L148">        assertTrue(d.isDisposed());</span>
<span class="fc" id="L149">    }</span>

    @Test
    public void dispose() {
<span class="fc" id="L153">        Disposable d = Disposables.empty();</span>

<span class="fc" id="L155">        Single.using(Functions.justCallable(d), mapper, disposer, false)</span>
<span class="fc" id="L156">        .test(true);</span>

<span class="fc" id="L158">        assertTrue(d.isDisposed());</span>
<span class="fc" id="L159">    }</span>

    @Test
    public void disposerThrowsEager() {
<span class="fc" id="L163">        Single.using(Functions.justCallable(Disposables.empty()), mapper, disposerThrows)</span>
<span class="fc" id="L164">        .test()</span>
<span class="fc" id="L165">        .assertFailure(TestException.class);</span>
<span class="fc" id="L166">    }</span>

    @Test
    public void disposerThrowsNonEager() {

<span class="fc" id="L171">        List&lt;Throwable&gt; errors = TestHelper.trackPluginErrors();</span>

        try {
<span class="fc" id="L174">            Single.using(Functions.justCallable(Disposables.empty()), mapper, disposerThrows, false)</span>
<span class="fc" id="L175">            .test()</span>
<span class="fc" id="L176">            .assertResult(1);</span>
<span class="fc" id="L177">            TestHelper.assertUndeliverable(errors, 0, TestException.class, &quot;Disposer&quot;);</span>
        } finally {
<span class="fc" id="L179">            RxJavaPlugins.reset();</span>
        }
<span class="fc" id="L181">    }</span>

    @Test
    public void errorAndDisposerThrowsEager() {
<span class="fc" id="L185">        TestObserver&lt;Integer&gt; to = Single.using(Functions.justCallable(Disposables.empty()),</span>
<span class="fc" id="L186">        new Function&lt;Disposable, SingleSource&lt;Integer&gt;&gt;() {</span>
            @Override
            public SingleSource&lt;Integer&gt; apply(Disposable v) throws Exception {
<span class="fc" id="L189">                return Single.&lt;Integer&gt;error(new TestException(&quot;Mapper-run&quot;));</span>
            }
        }, disposerThrows)
<span class="fc" id="L192">        .test()</span>
<span class="fc" id="L193">        .assertFailure(CompositeException.class);</span>

<span class="fc" id="L195">        List&lt;Throwable&gt; ce = TestHelper.compositeList(to.errors().get(0));</span>
<span class="fc" id="L196">        TestHelper.assertError(ce, 0, TestException.class, &quot;Mapper-run&quot;);</span>
<span class="fc" id="L197">        TestHelper.assertError(ce, 1, TestException.class, &quot;Disposer&quot;);</span>
<span class="fc" id="L198">    }</span>

    @Test
    public void errorAndDisposerThrowsNonEager() {
<span class="fc" id="L202">        List&lt;Throwable&gt; errors = TestHelper.trackPluginErrors();</span>

        try {
<span class="fc" id="L205">            Single.using(Functions.justCallable(Disposables.empty()),</span>
<span class="fc" id="L206">            new Function&lt;Disposable, SingleSource&lt;Integer&gt;&gt;() {</span>
                @Override
                public SingleSource&lt;Integer&gt; apply(Disposable v) throws Exception {
<span class="fc" id="L209">                    return Single.&lt;Integer&gt;error(new TestException(&quot;Mapper-run&quot;));</span>
                }
            }, disposerThrows, false)
<span class="fc" id="L212">            .test()</span>
<span class="fc" id="L213">            .assertFailure(TestException.class);</span>
<span class="fc" id="L214">            TestHelper.assertUndeliverable(errors, 0, TestException.class, &quot;Disposer&quot;);</span>
        } finally {
<span class="fc" id="L216">            RxJavaPlugins.reset();</span>
        }
<span class="fc" id="L218">    }</span>

    @Test
    public void successDisposeRace() {
<span class="fc bfc" id="L222" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L223">            final PublishProcessor&lt;Integer&gt; pp = PublishProcessor.create();</span>

<span class="fc" id="L225">            Disposable d = Disposables.empty();</span>

<span class="fc" id="L227">            final TestObserver&lt;Integer&gt; to = Single.using(Functions.justCallable(d), new Function&lt;Disposable, SingleSource&lt;Integer&gt;&gt;() {</span>
                @Override
                public SingleSource&lt;Integer&gt; apply(Disposable v) throws Exception {
<span class="fc" id="L230">                    return pp.single(-99);</span>
                }
            }, disposer)
<span class="fc" id="L233">            .test();</span>

<span class="fc" id="L235">            pp.onNext(1);</span>

<span class="fc" id="L237">            Runnable r1 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L240">                    pp.onComplete();</span>
<span class="fc" id="L241">                }</span>
            };
<span class="fc" id="L243">            Runnable r2 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L246">                    to.cancel();</span>
<span class="fc" id="L247">                }</span>
            };

<span class="fc" id="L250">            TestHelper.race(r1, r2);</span>

<span class="fc" id="L252">            assertTrue(d.isDisposed());</span>
        }
<span class="fc" id="L254">    }</span>

    @Test
    public void doubleOnSubscribe() {
<span class="fc" id="L258">        List&lt;Throwable&gt; errors = TestHelper.trackPluginErrors();</span>

        try {
<span class="fc" id="L261">            Single.using(Functions.justCallable(1), new Function&lt;Integer, SingleSource&lt;Integer&gt;&gt;() {</span>
                @Override
                public SingleSource&lt;Integer&gt; apply(Integer v) throws Exception {
<span class="fc" id="L264">                    return new Single&lt;Integer&gt;() {</span>
                        @Override
                        protected void subscribeActual(SingleObserver&lt;? super Integer&gt; observer) {
<span class="fc" id="L267">                            observer.onSubscribe(Disposables.empty());</span>

<span class="fc" id="L269">                            assertFalse(((Disposable)observer).isDisposed());</span>

<span class="fc" id="L271">                            Disposable d = Disposables.empty();</span>
<span class="fc" id="L272">                            observer.onSubscribe(d);</span>

<span class="fc" id="L274">                            assertTrue(d.isDisposed());</span>

<span class="fc" id="L276">                            assertFalse(((Disposable)observer).isDisposed());</span>

<span class="fc" id="L278">                            observer.onSuccess(1);</span>

<span class="fc" id="L280">                            assertTrue(((Disposable)observer).isDisposed());</span>
<span class="fc" id="L281">                        }</span>
                    };
                }
<span class="fc" id="L284">            }, Functions.emptyConsumer())</span>
<span class="fc" id="L285">            .test()</span>
<span class="fc" id="L286">            .assertResult(1)</span>
            ;

<span class="fc" id="L289">            TestHelper.assertError(errors, 0, IllegalStateException.class, &quot;Disposable already set!&quot;);</span>
        } finally {
<span class="fc" id="L291">            RxJavaPlugins.reset();</span>
        }
<span class="fc" id="L293">    }</span>

    @Test
    public void errorDisposeRace() {
<span class="fc bfc" id="L297" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L298">            final PublishProcessor&lt;Integer&gt; pp = PublishProcessor.create();</span>

<span class="fc" id="L300">            Disposable d = Disposables.empty();</span>

<span class="fc" id="L302">            final TestObserver&lt;Integer&gt; to = Single.using(Functions.justCallable(d), new Function&lt;Disposable, SingleSource&lt;Integer&gt;&gt;() {</span>
                @Override
                public SingleSource&lt;Integer&gt; apply(Disposable v) throws Exception {
<span class="fc" id="L305">                    return pp.single(-99);</span>
                }
            }, disposer)
<span class="fc" id="L308">            .test();</span>

<span class="fc" id="L310">            final TestException ex = new TestException();</span>

<span class="fc" id="L312">            Runnable r1 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L315">                    pp.onError(ex);</span>
<span class="fc" id="L316">                }</span>
            };
<span class="fc" id="L318">            Runnable r2 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L321">                    to.cancel();</span>
<span class="fc" id="L322">                }</span>
            };

<span class="fc" id="L325">            TestHelper.race(r1, r2);</span>

<span class="fc" id="L327">            assertTrue(d.isDisposed());</span>
        }
<span class="fc" id="L329">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>