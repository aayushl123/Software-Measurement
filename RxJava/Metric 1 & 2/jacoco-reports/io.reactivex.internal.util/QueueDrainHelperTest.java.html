<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>QueueDrainHelperTest.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">RxJava_2_x$Unnamed.exec</a> &gt; <a href="index.source.html" class="el_package">io.reactivex.internal.util</a> &gt; <span class="el_source">QueueDrainHelperTest.java</span></div><h1>QueueDrainHelperTest.java</h1><pre class="source lang-java linenums">/**
 * Copyright (c) 2016-present, RxJava Contributors.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;); you may not use this file except in
 * compliance with the License. You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is
 * distributed on an &quot;AS IS&quot; BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See
 * the License for the specific language governing permissions and limitations under the License.
 */

package io.reactivex.internal.util;

import static org.junit.Assert.*;

import java.io.IOException;
import java.util.*;
import java.util.concurrent.atomic.AtomicLong;

import org.junit.Test;
import org.reactivestreams.*;

import io.reactivex.Observer;
import io.reactivex.TestHelper;
import io.reactivex.disposables.*;
import io.reactivex.exceptions.*;
import io.reactivex.functions.BooleanSupplier;
import io.reactivex.internal.queue.SpscArrayQueue;
import io.reactivex.internal.subscriptions.BooleanSubscription;
import io.reactivex.observers.TestObserver;
import io.reactivex.subscribers.TestSubscriber;

<span class="fc" id="L35">public class QueueDrainHelperTest {</span>

    @Test
    public void isCancelled() {
<span class="fc" id="L39">        assertTrue(QueueDrainHelper.isCancelled(new BooleanSupplier() {</span>
            @Override
            public boolean getAsBoolean() throws Exception {
<span class="fc" id="L42">                throw new IOException();</span>
            }
        }));
<span class="fc" id="L45">    }</span>

    @Test
    public void requestMaxInt() {
<span class="fc" id="L49">        QueueDrainHelper.request(new Subscription() {</span>
            @Override
            public void request(long n) {
<span class="fc" id="L52">                assertEquals(Integer.MAX_VALUE, n);</span>
<span class="fc" id="L53">            }</span>

            @Override
            public void cancel() {
<span class="nc" id="L57">            }</span>
        }, Integer.MAX_VALUE);
<span class="fc" id="L59">    }</span>

    @Test
    public void requestMinInt() {
<span class="fc" id="L63">        QueueDrainHelper.request(new Subscription() {</span>
            @Override
            public void request(long n) {
<span class="fc" id="L66">                assertEquals(Long.MAX_VALUE, n);</span>
<span class="fc" id="L67">            }</span>

            @Override
            public void cancel() {
<span class="nc" id="L71">            }</span>
        }, Integer.MIN_VALUE);
<span class="fc" id="L73">    }</span>

    @Test
    public void requestAlmostMaxInt() {
<span class="fc" id="L77">        QueueDrainHelper.request(new Subscription() {</span>
            @Override
            public void request(long n) {
<span class="fc" id="L80">                assertEquals(Integer.MAX_VALUE - 1, n);</span>
<span class="fc" id="L81">            }</span>

            @Override
            public void cancel() {
<span class="nc" id="L85">            }</span>
        }, Integer.MAX_VALUE - 1);
<span class="fc" id="L87">    }</span>

    @Test
    public void postCompleteEmpty() {
<span class="fc" id="L91">        TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L92">        ArrayDeque&lt;Integer&gt; queue = new ArrayDeque&lt;Integer&gt;();</span>
<span class="fc" id="L93">        AtomicLong state = new AtomicLong();</span>
<span class="fc" id="L94">        BooleanSupplier isCancelled = new BooleanSupplier() {</span>
            @Override
            public boolean getAsBoolean() throws Exception {
<span class="nc" id="L97">                return false;</span>
            }
        };

<span class="fc" id="L101">        ts.onSubscribe(new BooleanSubscription());</span>

<span class="fc" id="L103">        QueueDrainHelper.postComplete(ts, queue, state, isCancelled);</span>

<span class="fc" id="L105">        ts.assertResult();</span>
<span class="fc" id="L106">    }</span>

    @Test
    public void postCompleteWithRequest() {
<span class="fc" id="L110">        TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L111">        ArrayDeque&lt;Integer&gt; queue = new ArrayDeque&lt;Integer&gt;();</span>
<span class="fc" id="L112">        AtomicLong state = new AtomicLong();</span>
<span class="fc" id="L113">        BooleanSupplier isCancelled = new BooleanSupplier() {</span>
            @Override
            public boolean getAsBoolean() throws Exception {
<span class="fc" id="L116">                return false;</span>
            }
        };

<span class="fc" id="L120">        ts.onSubscribe(new BooleanSubscription());</span>
<span class="fc" id="L121">        queue.offer(1);</span>
<span class="fc" id="L122">        state.getAndIncrement();</span>

<span class="fc" id="L124">        QueueDrainHelper.postComplete(ts, queue, state, isCancelled);</span>

<span class="fc" id="L126">        ts.assertResult(1);</span>
<span class="fc" id="L127">    }</span>

    @Test
    public void completeRequestRace() {
<span class="fc bfc" id="L131" title="All 2 branches covered.">        for (int i = 0; i &lt; TestHelper.RACE_DEFAULT_LOOPS; i++) {</span>
<span class="fc" id="L132">            final TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L133">            final ArrayDeque&lt;Integer&gt; queue = new ArrayDeque&lt;Integer&gt;();</span>
<span class="fc" id="L134">            final AtomicLong state = new AtomicLong();</span>
<span class="fc" id="L135">            final BooleanSupplier isCancelled = new BooleanSupplier() {</span>
                @Override
                public boolean getAsBoolean() throws Exception {
<span class="fc" id="L138">                    return false;</span>
                }
            };

<span class="fc" id="L142">            ts.onSubscribe(new BooleanSubscription());</span>
<span class="fc" id="L143">            queue.offer(1);</span>

<span class="fc" id="L145">            Runnable r1 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L148">                    QueueDrainHelper.postCompleteRequest(1, ts, queue, state, isCancelled);</span>
<span class="fc" id="L149">                }</span>
            };

<span class="fc" id="L152">            Runnable r2 = new Runnable() {</span>
                @Override
                public void run() {
<span class="fc" id="L155">                    QueueDrainHelper.postComplete(ts, queue, state, isCancelled);</span>
<span class="fc" id="L156">                }</span>
            };

<span class="fc" id="L159">            TestHelper.race(r1, r2);</span>

<span class="fc" id="L161">            ts.assertResult(1);</span>
        }
<span class="fc" id="L163">    }</span>

    @Test
    public void postCompleteCancelled() {
<span class="fc" id="L167">        final TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L168">        ArrayDeque&lt;Integer&gt; queue = new ArrayDeque&lt;Integer&gt;();</span>
<span class="fc" id="L169">        AtomicLong state = new AtomicLong();</span>
<span class="fc" id="L170">        BooleanSupplier isCancelled = new BooleanSupplier() {</span>
            @Override
            public boolean getAsBoolean() throws Exception {
<span class="fc" id="L173">                return ts.isCancelled();</span>
            }
        };

<span class="fc" id="L177">        ts.onSubscribe(new BooleanSubscription());</span>
<span class="fc" id="L178">        queue.offer(1);</span>
<span class="fc" id="L179">        state.getAndIncrement();</span>
<span class="fc" id="L180">        ts.cancel();</span>

<span class="fc" id="L182">        QueueDrainHelper.postComplete(ts, queue, state, isCancelled);</span>

<span class="fc" id="L184">        ts.assertEmpty();</span>
<span class="fc" id="L185">    }</span>

    @Test
    public void postCompleteCancelledAfterOne() {
<span class="fc" id="L189">        final TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;() {</span>
            @Override
            public void onNext(Integer t) {
<span class="fc" id="L192">                super.onNext(t);</span>
<span class="fc" id="L193">                cancel();</span>
<span class="fc" id="L194">            }</span>
        };
<span class="fc" id="L196">        ArrayDeque&lt;Integer&gt; queue = new ArrayDeque&lt;Integer&gt;();</span>
<span class="fc" id="L197">        AtomicLong state = new AtomicLong();</span>
<span class="fc" id="L198">        BooleanSupplier isCancelled = new BooleanSupplier() {</span>
            @Override
            public boolean getAsBoolean() throws Exception {
<span class="fc" id="L201">                return ts.isCancelled();</span>
            }
        };

<span class="fc" id="L205">        ts.onSubscribe(new BooleanSubscription());</span>
<span class="fc" id="L206">        queue.offer(1);</span>
<span class="fc" id="L207">        state.getAndIncrement();</span>

<span class="fc" id="L209">        QueueDrainHelper.postComplete(ts, queue, state, isCancelled);</span>

<span class="fc" id="L211">        ts.assertValue(1).assertNoErrors().assertNotComplete();</span>
<span class="fc" id="L212">    }</span>

    @Test
    public void drainMaxLoopMissingBackpressure() {
<span class="fc" id="L216">        TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L217">        ts.onSubscribe(new BooleanSubscription());</span>

<span class="fc" id="L219">        QueueDrain&lt;Integer, Integer&gt; qd = new QueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L222">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="fc" id="L227">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="nc" id="L232">                return null;</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L237">                return true;</span>
            }

            @Override
            public long requested() {
<span class="fc" id="L242">                return 0;</span>
            }

            @Override
            public long produced(long n) {
<span class="nc" id="L247">                return 0;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L252">                return 0;</span>
            }

            @Override
            public boolean accept(Subscriber&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L257">                return false;</span>
            }
        };

<span class="fc" id="L261">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>
<span class="fc" id="L262">        q.offer(1);</span>

<span class="fc" id="L264">        QueueDrainHelper.drainMaxLoop(q, ts, false, null, qd);</span>

<span class="fc" id="L266">        ts.assertFailure(MissingBackpressureException.class);</span>
<span class="fc" id="L267">    }</span>

    @Test
    public void drainMaxLoopMissingBackpressureWithResource() {
<span class="fc" id="L271">        TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L272">        ts.onSubscribe(new BooleanSubscription());</span>

<span class="fc" id="L274">        QueueDrain&lt;Integer, Integer&gt; qd = new QueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L277">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="fc" id="L282">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="nc" id="L287">                return null;</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L292">                return true;</span>
            }

            @Override
            public long requested() {
<span class="fc" id="L297">                return 0;</span>
            }

            @Override
            public long produced(long n) {
<span class="nc" id="L302">                return 0;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L307">                return 0;</span>
            }

            @Override
            public boolean accept(Subscriber&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L312">                return false;</span>
            }
        };

<span class="fc" id="L316">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>
<span class="fc" id="L317">        q.offer(1);</span>

<span class="fc" id="L319">        Disposable d = Disposables.empty();</span>

<span class="fc" id="L321">        QueueDrainHelper.drainMaxLoop(q, ts, false, d, qd);</span>

<span class="fc" id="L323">        ts.assertFailure(MissingBackpressureException.class);</span>

<span class="fc" id="L325">        assertTrue(d.isDisposed());</span>
<span class="fc" id="L326">    }</span>

    @Test
    public void drainMaxLoopDontAccept() {
<span class="fc" id="L330">        TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L331">        ts.onSubscribe(new BooleanSubscription());</span>

<span class="fc" id="L333">        QueueDrain&lt;Integer, Integer&gt; qd = new QueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L336">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="fc" id="L341">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="nc" id="L346">                return null;</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L351">                return true;</span>
            }

            @Override
            public long requested() {
<span class="fc" id="L356">                return 1;</span>
            }

            @Override
            public long produced(long n) {
<span class="nc" id="L361">                return 0;</span>
            }

            @Override
            public int leave(int m) {
<span class="fc" id="L366">                return 0;</span>
            }

            @Override
            public boolean accept(Subscriber&lt;? super Integer&gt; a, Integer v) {
<span class="fc" id="L371">                return false;</span>
            }
        };

<span class="fc" id="L375">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>
<span class="fc" id="L376">        q.offer(1);</span>

<span class="fc" id="L378">        QueueDrainHelper.drainMaxLoop(q, ts, false, null, qd);</span>

<span class="fc" id="L380">        ts.assertEmpty();</span>
<span class="fc" id="L381">    }</span>

    @Test
    public void checkTerminatedDelayErrorEmpty() {
<span class="fc" id="L385">        TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L386">        ts.onSubscribe(new BooleanSubscription());</span>

<span class="fc" id="L388">        QueueDrain&lt;Integer, Integer&gt; qd = new QueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L391">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="nc" id="L396">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="fc" id="L401">                return null;</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L406">                return true;</span>
            }

            @Override
            public long requested() {
<span class="nc" id="L411">                return 0;</span>
            }

            @Override
            public long produced(long n) {
<span class="nc" id="L416">                return 0;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L421">                return 0;</span>
            }

            @Override
            public boolean accept(Subscriber&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L426">                return false;</span>
            }
        };

<span class="fc" id="L430">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>

<span class="fc" id="L432">        QueueDrainHelper.checkTerminated(true, true, ts, true, q, qd);</span>

<span class="fc" id="L434">        ts.assertResult();</span>
<span class="fc" id="L435">    }</span>

    @Test
    public void checkTerminatedDelayErrorNonEmpty() {
<span class="fc" id="L439">        TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L440">        ts.onSubscribe(new BooleanSubscription());</span>

<span class="fc" id="L442">        QueueDrain&lt;Integer, Integer&gt; qd = new QueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L445">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="nc" id="L450">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="nc" id="L455">                return null;</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L460">                return true;</span>
            }

            @Override
            public long requested() {
<span class="nc" id="L465">                return 0;</span>
            }

            @Override
            public long produced(long n) {
<span class="nc" id="L470">                return 0;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L475">                return 0;</span>
            }

            @Override
            public boolean accept(Subscriber&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L480">                return false;</span>
            }
        };

<span class="fc" id="L484">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>

<span class="fc" id="L486">        QueueDrainHelper.checkTerminated(true, false, ts, true, q, qd);</span>

<span class="fc" id="L488">        ts.assertEmpty();</span>
<span class="fc" id="L489">    }</span>

    @Test
    public void checkTerminatedDelayErrorEmptyError() {
<span class="fc" id="L493">        TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L494">        ts.onSubscribe(new BooleanSubscription());</span>

<span class="fc" id="L496">        QueueDrain&lt;Integer, Integer&gt; qd = new QueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L499">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="nc" id="L504">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="fc" id="L509">                return new TestException();</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L514">                return true;</span>
            }

            @Override
            public long requested() {
<span class="nc" id="L519">                return 0;</span>
            }

            @Override
            public long produced(long n) {
<span class="nc" id="L524">                return 0;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L529">                return 0;</span>
            }

            @Override
            public boolean accept(Subscriber&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L534">                return false;</span>
            }
        };

<span class="fc" id="L538">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>

<span class="fc" id="L540">        QueueDrainHelper.checkTerminated(true, true, ts, true, q, qd);</span>

<span class="fc" id="L542">        ts.assertFailure(TestException.class);</span>
<span class="fc" id="L543">    }</span>

    @Test
    public void checkTerminatedNonDelayErrorError() {
<span class="fc" id="L547">        TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>
<span class="fc" id="L548">        ts.onSubscribe(new BooleanSubscription());</span>

<span class="fc" id="L550">        QueueDrain&lt;Integer, Integer&gt; qd = new QueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L553">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="nc" id="L558">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="fc" id="L563">                return new TestException();</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L568">                return true;</span>
            }

            @Override
            public long requested() {
<span class="nc" id="L573">                return 0;</span>
            }

            @Override
            public long produced(long n) {
<span class="nc" id="L578">                return 0;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L583">                return 0;</span>
            }

            @Override
            public boolean accept(Subscriber&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L588">                return false;</span>
            }
        };

<span class="fc" id="L592">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>

<span class="fc" id="L594">        QueueDrainHelper.checkTerminated(true, false, ts, false, q, qd);</span>

<span class="fc" id="L596">        ts.assertFailure(TestException.class);</span>
<span class="fc" id="L597">    }</span>

    @Test
    public void observerCheckTerminatedDelayErrorEmpty() {
<span class="fc" id="L601">        TestObserver&lt;Integer&gt; to = new TestObserver&lt;Integer&gt;();</span>
<span class="fc" id="L602">        to.onSubscribe(Disposables.empty());</span>

<span class="fc" id="L604">        ObservableQueueDrain&lt;Integer, Integer&gt; qd = new ObservableQueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L607">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="nc" id="L612">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="fc" id="L617">                return null;</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L622">                return true;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L627">                return 0;</span>
            }

            @Override
            public void accept(Observer&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L632">            }</span>
        };

<span class="fc" id="L635">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>

<span class="fc" id="L637">        QueueDrainHelper.checkTerminated(true, true, to, true, q, null, qd);</span>

<span class="fc" id="L639">        to.assertResult();</span>
<span class="fc" id="L640">    }</span>

    @Test
    public void observerCheckTerminatedDelayErrorEmptyResource() {
<span class="fc" id="L644">        TestObserver&lt;Integer&gt; to = new TestObserver&lt;Integer&gt;();</span>
<span class="fc" id="L645">        to.onSubscribe(Disposables.empty());</span>

<span class="fc" id="L647">        ObservableQueueDrain&lt;Integer, Integer&gt; qd = new ObservableQueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L650">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="nc" id="L655">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="fc" id="L660">                return null;</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L665">                return true;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L670">                return 0;</span>
            }

            @Override
            public void accept(Observer&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L675">            }</span>
        };

<span class="fc" id="L678">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>

<span class="fc" id="L680">        Disposable d = Disposables.empty();</span>

<span class="fc" id="L682">        QueueDrainHelper.checkTerminated(true, true, to, true, q, d, qd);</span>

<span class="fc" id="L684">        to.assertResult();</span>

<span class="fc" id="L686">        assertTrue(d.isDisposed());</span>
<span class="fc" id="L687">    }</span>

    @Test
    public void observerCheckTerminatedDelayErrorNonEmpty() {
<span class="fc" id="L691">        TestObserver&lt;Integer&gt; to = new TestObserver&lt;Integer&gt;();</span>
<span class="fc" id="L692">        to.onSubscribe(Disposables.empty());</span>

<span class="fc" id="L694">        ObservableQueueDrain&lt;Integer, Integer&gt; qd = new ObservableQueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L697">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="nc" id="L702">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="nc" id="L707">                return null;</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L712">                return true;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L717">                return 0;</span>
            }

            @Override
            public void accept(Observer&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L722">            }</span>
        };

<span class="fc" id="L725">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>

<span class="fc" id="L727">        QueueDrainHelper.checkTerminated(true, false, to, true, q, null, qd);</span>

<span class="fc" id="L729">        to.assertEmpty();</span>
<span class="fc" id="L730">    }</span>

    @Test
    public void observerCheckTerminatedDelayErrorEmptyError() {
<span class="fc" id="L734">        TestObserver&lt;Integer&gt; to = new TestObserver&lt;Integer&gt;();</span>
<span class="fc" id="L735">        to.onSubscribe(Disposables.empty());</span>

<span class="fc" id="L737">        ObservableQueueDrain&lt;Integer, Integer&gt; qd = new ObservableQueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L740">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="nc" id="L745">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="fc" id="L750">                return new TestException();</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L755">                return true;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L760">                return 0;</span>
            }

            @Override
            public void accept(Observer&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L765">            }</span>
        };

<span class="fc" id="L768">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>

<span class="fc" id="L770">        QueueDrainHelper.checkTerminated(true, true, to, true, q, null, qd);</span>

<span class="fc" id="L772">        to.assertFailure(TestException.class);</span>
<span class="fc" id="L773">    }</span>

    @Test
    public void observerCheckTerminatedNonDelayErrorError() {
<span class="fc" id="L777">        TestObserver&lt;Integer&gt; to = new TestObserver&lt;Integer&gt;();</span>
<span class="fc" id="L778">        to.onSubscribe(Disposables.empty());</span>

<span class="fc" id="L780">        ObservableQueueDrain&lt;Integer, Integer&gt; qd = new ObservableQueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L783">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="nc" id="L788">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="fc" id="L793">                return new TestException();</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L798">                return true;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L803">                return 0;</span>
            }

            @Override
            public void accept(Observer&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L808">            }</span>
        };

<span class="fc" id="L811">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>

<span class="fc" id="L813">        QueueDrainHelper.checkTerminated(true, false, to, false, q, null, qd);</span>

<span class="fc" id="L815">        to.assertFailure(TestException.class);</span>
<span class="fc" id="L816">    }</span>

    @Test
    public void observerCheckTerminatedNonDelayErrorErrorResource() {
<span class="fc" id="L820">        TestObserver&lt;Integer&gt; to = new TestObserver&lt;Integer&gt;();</span>
<span class="fc" id="L821">        to.onSubscribe(Disposables.empty());</span>

<span class="fc" id="L823">        ObservableQueueDrain&lt;Integer, Integer&gt; qd = new ObservableQueueDrain&lt;Integer, Integer&gt;() {</span>
            @Override
            public boolean cancelled() {
<span class="fc" id="L826">                return false;</span>
            }

            @Override
            public boolean done() {
<span class="nc" id="L831">                return false;</span>
            }

            @Override
            public Throwable error() {
<span class="fc" id="L836">                return new TestException();</span>
            }

            @Override
            public boolean enter() {
<span class="nc" id="L841">                return true;</span>
            }

            @Override
            public int leave(int m) {
<span class="nc" id="L846">                return 0;</span>
            }

            @Override
            public void accept(Observer&lt;? super Integer&gt; a, Integer v) {
<span class="nc" id="L851">            }</span>
        };

<span class="fc" id="L854">        SpscArrayQueue&lt;Integer&gt; q = new SpscArrayQueue&lt;Integer&gt;(32);</span>

<span class="fc" id="L856">        Disposable d = Disposables.empty();</span>

<span class="fc" id="L858">        QueueDrainHelper.checkTerminated(true, false, to, false, q, d, qd);</span>

<span class="fc" id="L860">        to.assertFailure(TestException.class);</span>

<span class="fc" id="L862">        assertTrue(d.isDisposed());</span>
<span class="fc" id="L863">    }</span>

    @Test
    public void postCompleteAlreadyComplete() {

<span class="fc" id="L868">        TestSubscriber&lt;Integer&gt; ts = new TestSubscriber&lt;Integer&gt;();</span>

<span class="fc" id="L870">        Queue&lt;Integer&gt; q = new ArrayDeque&lt;Integer&gt;();</span>
<span class="fc" id="L871">        q.offer(1);</span>

<span class="fc" id="L873">        AtomicLong state = new AtomicLong(QueueDrainHelper.COMPLETED_MASK);</span>

<span class="fc" id="L875">        QueueDrainHelper.postComplete(ts, q, state, new BooleanSupplier() {</span>
            @Override
            public boolean getAsBoolean() throws Exception {
<span class="fc" id="L878">                return false;</span>
            }
        });
<span class="fc" id="L881">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.2.201808211720</span></div></body></html>